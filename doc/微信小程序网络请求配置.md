# 🔧 微信小程序网络请求配置指南

## ❌ 问题描述

```
搜索请求失败详情: {errMsg: "request:fail", errno: undefined}
```

**原因**: 微信小程序默认不允许访问`localhost`或未配置的域名

---

## ✅ 解决方案

### 方案1: 开启"不校验合法域名"(推荐用于开发)

1. 打开**微信开发者工具**
2. 点击右上角**详情**按钮
3. 在**本地设置**标签页中
4. 勾选 ✅ **不校验合法域名、web-view(业务域名)、TLS版本以及HTTPS证书**

![设置示意](https://developers.weixin.qq.com/miniprogram/dev/devtools/images/setting.png)

---

### 方案2: 使用本机IP地址

#### 步骤1: 获取本机IP

**Windows**:
```bash
ipconfig
```
查找"IPv4 地址",例如: `192.168.1.100`

**Mac/Linux**:
```bash
ifconfig
```

#### 步骤2: 修改baseUrl

修改 `pages/search/search.vue` 第53行:

```javascript
// 修改前
baseUrl: 'http://localhost:9000',

// 修改后(替换为你的IP)
baseUrl: 'http://192.168.1.100:9000',
```

#### 步骤3: 确保手机和电脑在同一网络

如果使用真机调试,确保:
- 手机和电脑连接同一个WiFi
- 防火墙允许9000端口访问

---

### 方案3: 配置合法域名(用于生产环境)

#### 步骤1: 准备域名和服务器

1. 购买域名(如: `api.yourapp.com`)
2. 购买服务器并部署后端
3. 配置HTTPS证书(微信小程序要求HTTPS)

#### 步骤2: 在微信公众平台配置

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入**开发** → **开发管理** → **开发设置**
3. 在**服务器域名**中添加:
   - request合法域名: `https://api.yourapp.com`
   - uploadFile合法域名: `https://api.yourapp.com`
   - downloadFile合法域名: `https://api.yourapp.com`

#### 步骤3: 修改代码

```javascript
baseUrl: 'https://api.yourapp.com',
```

---

## 🔍 验证配置

### 检查清单

- [ ] 微信开发者工具已开启"不校验合法域名"
- [ ] manifest.json中`urlCheck`设置为`false`
- [ ] 后端服务正在运行(端口9000)
- [ ] 能在浏览器访问 `http://localhost:9000/api/plants/search?q=松`

### 测试步骤

1. **重新编译小程序**
   - 在微信开发者工具中点击"编译"

2. **查看控制台**
   - 打开"调试器"标签
   - 查看Console输出
   - 应该看到: `发起搜索请求 URL: http://localhost:9000/api/plants/search`

3. **查看Network**
   - 切换到"Network"标签
   - 查看请求状态
   - 成功的请求应该是200状态码

---

## 📝 需要修改的文件

如果使用IP地址方案,需要修改以下文件:

### 1. pages/search/search.vue
```javascript
baseUrl: 'http://192.168.1.100:9000',  // 替换为你的IP
```

### 2. pages/plant-detail/plant-detail.vue
```javascript
baseUrl: 'http://192.168.1.100:9000',  // 替换为你的IP
```

### 3. pages/identify/identify.vue
```javascript
baseUrl: 'http://192.168.1.100:9000',  // 替换为你的IP
```

---

## ⚠️ 常见问题

### Q1: 开启"不校验合法域名"后仍然失败

**解决**:
1. 完全关闭微信开发者工具
2. 重新打开项目
3. 重新编译

### Q2: 使用IP地址后手机无法访问

**解决**:
1. 检查手机和电脑是否在同一WiFi
2. 关闭电脑防火墙或添加9000端口例外
3. 确认后端监听的是`0.0.0.0`而不是`127.0.0.1`

### Q3: 真机调试时网络请求失败

**解决**:
1. 确保使用IP地址而不是localhost
2. 在微信开发者工具中开启"不校验合法域名"
3. 真机预览时也会应用这个设置

---

## 🎯 推荐配置(开发环境)

### 微信开发者工具设置

```
详情 → 本地设置:
✅ 不校验合法域名、web-view(业务域名)、TLS版本以及HTTPS证书
✅ 不校验安全域名、TLS版本以及HTTPS证书
✅ 允许HTTP请求
```

### manifest.json

```json
"mp-weixin": {
  "appid": "wx1d437d173958f33e",
  "setting": {
    "urlCheck": false
  },
  "usingComponents": true
}
```

---

## 📱 真机调试配置

如果需要在真机上测试:

1. **获取本机IP**: 
   ```bash
   ipconfig  # Windows
   ifconfig  # Mac/Linux
   ```

2. **修改所有页面的baseUrl**:
   ```javascript
   baseUrl: 'http://192.168.1.100:9000'
   ```

3. **确保后端监听所有网卡**:
   
   检查 `server/app.js` 第522行:
   ```javascript
   app.listen(PORT, '0.0.0.0', () => {
     console.log(`服务已启动,监听端口: ${PORT}`);
   });
   ```

4. **关闭防火墙或添加规则**:
   
   **Windows**:
   ```powershell
   # 允许9000端口
   netsh advfirewall firewall add rule name="Node Server" dir=in action=allow protocol=TCP localport=9000
   ```

---

## ✅ 快速解决步骤

1. **打开微信开发者工具**
2. **点击右上角"详情"**
3. **勾选"不校验合法域名..."**
4. **点击"编译"重新编译**
5. **测试搜索功能**

如果还是失败,请检查:
- 后端是否正在运行(端口9000)
- 浏览器能否访问 http://localhost:9000/api/plants/search?q=松
- 控制台是否有其他错误信息

---

**更新时间**: 2026-02-06  
**适用版本**: 微信开发者工具 2.01.x+
